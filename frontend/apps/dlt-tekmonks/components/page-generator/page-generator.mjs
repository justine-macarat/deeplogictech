import{monkshu_component}from"/framework/js/monkshu_component.mjs";import{router}from"/framework/js/router.mjs";import{session}from"/framework/js/session.mjs";function register(){monkshu_component.register("page-generator",null,page_generator)}async function elementConnected(t){let e=await fetch(t.getAttribute("file"),{mode:"no-cors"}).then((t=>t.text())),n=e.match(/SCHEMA\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),r=n&&n.length>1?n[1]:"",s=e.match(/CSS\s+CLASSES\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),l=s&&s.length>1?s[1]:"";l=l.replace("CONTAINER CLASSES","containerClasses").replace("ITEM CLASSES","itemClasses").replace("PER ITEM CLASS","perItemClass");let o={},i=l.split("\n");l&&""!=l&&i.forEach((t=>{let e=t.split("=");o[e[0].trim()]=e[1].trim()}));let a=e.match(/CSS\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),c=a&&a.length>1?a[1]:"",m=e.match(/LAYOUT\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),h=m&&m.length>1?m[1]:"";h=h.replace(/^[\|-\s]+$/gm,"").replace(/(?:[\t\s]*(?:\r?\n|\r)){2}/gm,"\n").trim();let g=h.split(/\r?\n/),d=0,u=-1;if(g.forEach(((t,e)=>{let n=(t.match(/\|/g)||[0]).length-1;n>d&&(d=n,u=e)})),-1==u)return;let f=[];[...g[u]].forEach(((t,e)=>{"|"==t&&f.push(e)}));let p=[];g.forEach(((t,e)=>{let n,r=!1;f.forEach(((s,l)=>{if("|"==t[s])if(r=!r,r)n={colStart:l};else{n.colEnd=l,n.rowStart=e,n.rowEnd=e+1,n.element=t.substring(f[n.colStart]+1,f[n.colEnd]-1).trim();let s=findObject(p,n.colStart,n.colEnd,e,n.element);s?s.rowEnd=e+1:p.push(n),l<f.length&&(r=!0,n={colStart:l})}}))}));let w=e.match(/LAYOUT\s*\r?\n=+\r?\n.+?\r?\n=+\r?\n(Row\s+Heights.+?Col\s+Widths.+?)\r?\n=+[\r?\n]*/ms),S=w&&w.length>1?w[1]:"",C=S.match(/^\s*Row\s+Heights\s+\=\s+(.+?)$/ms),E=[];C&&C.length>1&&(E=C[1].split(",")),E.forEach(((t,e)=>E[e]=t.trim()));let $=S.match(/^\s*Col\s+Widths\s+\=\s+(.+?)$/ms),A=[];$&&$.length>1&&(A=$[1].split(",")),A.forEach(((t,e)=>A[e]=t.trim()));let _={rows:g.length,columns:f.length-1,rowHeights:E,colWidths:A,elementsAndPlacements:p};t.componentHTML=await generatePageHTML(t,r,o,c,t.getAttribute("css"),_)}async function generatePageHTML(t,e,n,r,s,l){t.webscrolls_env||(t.webscrolls_env={}),l.rowHeights.length<l.rows.length&&l.rowHeights.push(Array(l.rows.length-l.rowHeights.length).fill("auto")),l.colWidths.length<l.columns.length&&l.colWidths.push(Array(l.columns.length-l.colWidths.length).fill("auto"));let o=`${s?`<link rel="stylesheet" type="text/css" href="${s}">`:""}\n\t<style>\n\t.grid-container {\n\t\tdisplay: grid;\n\t\tgrid-template-rows: ${l.rowHeights.join(" ")};\n\t\tgrid-template-columns: ${l.colWidths.join(" ")};\n\t}\n\t`,i=`<div class="grid-container${n.containerClasses?" "+n.containerClasses:""}">\n\t`;for(const[t,r]of l.elementsAndPlacements.entries()){o+=`.item${t} {\n\t\t\tgrid-column: ${r.colStart+1} / ${r.colEnd+1};\n\t\t\tgrid-row: ${r.rowStart+1} / ${r.rowEnd+1};\n\t\t\toverflow: hidden;\n\t\t}\n\t\t`;let s=JSON.parse(e)[r.element];s.id=r.name||r.element,i+=`<div class="item${t}${n.itemClasses?" "+n.itemClasses:""}${n.perItemClass?` ${n.perItemClass}-${s.id}`:""}"><${s.html||"div"}`,delete s.html;let l=s.__org_monkshu_innerHTML||"";delete s.__org_monkshu_innerHTML;for(const t of Object.keys(s))i+=` ${t}="${await evalAttrValue(s[t])}"`;i+=`>${l}</${s.html}></div>\n\t\t`}return o+=r,o+="</style>",i+="</div>",o+i}async function evalAttrValue(t){let e=(window[t]||t).toString();if(e=await router.expandPageData(e,session.get($$.MONKSHU_CONSTANTS.PAGE_URL),{}),e.match(/url\(.+\)/))try{let t=router.decodeURL(e.trim().substring(4,e.length-1)),n=await fetch(t);n.ok&&(e=await n.text())}catch{}return e}function findObject(t,e,n,r,s){for(let l of t)if(l.colStart==e&&l.colEnd==n&&l.rowEnd==r&&l.element==s)return l;return null}const trueWebComponentMode=!0;export const page_generator={trueWebComponentMode:true,register:register,elementConnected:elementConnected};