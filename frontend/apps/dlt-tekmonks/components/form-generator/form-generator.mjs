import{monkshu_component}from"/framework/js/monkshu_component.mjs";import{router}from"/framework/js/router.mjs";import{session}from"/framework/js/session.mjs";import{util}from"/framework/js/util.mjs";function register(){monkshu_component.register("form-generator",null,form_generator)}function submit(e,t){let n=e?this.elements[e]:this.element,r={};for(e of n.webscrolls_env.formGeneratorIDs){let t=n.shadowRoot.querySelector(`#${e}`);t.name&&(r[e]=t.value)}0!=t.indexOf("()")&&(t=t.split("()")[0]);let s=util.getFunctionFromString(t);s?s(r):LOG.debug(`Form submission handler ${t} not available.`)}async function elementConnected(e){let t=await fetch(e.getAttribute("file"),{mode:"no-cors"}).then((e=>e.text())),n=t.match(/SCHEMA\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),r=n&&n.length>1?n[1]:"",s=t.match(/CSS\s+CLASSES\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),o=s&&s.length>1?s[1]:"";o=o.replace("CONTAINER CLASSES","containerClasses").replace("ITEM CLASSES","itemClasses").replace("PER ITEM CLASS","perItemClass");let l={},i=o.split("\n");o&&""!=o&&i.forEach((e=>{let t=e.split("=");l[t[0].trim()]=t[1].trim()}));let m=t.match(/CSS\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),a=m&&m.length>1?m[1]:"",c=t.match(/LAYOUT\s*\r?\n=+\r?\n(.+?)\r?\n=+[\r?\n]*/ms),h=c&&c.length>1?c[1]:"";h=h.replace(/^[\|-\s]+$/gm,"").replace(/(?:[\t\s]*(?:\r?\n|\r)){2}/gm,"\n").trim();let g=h.split(/\r?\n/),u=0,d=-1;if(g.forEach(((e,t)=>{let n=(e.match(/\|/g)||[0]).length-1;n>u&&(u=n,d=t)})),-1==d)return;let f=[];[...g[d]].forEach(((e,t)=>{"|"==e&&f.push(t)}));let p=[];g.forEach(((e,t)=>{let n,r=!1;f.forEach(((s,o)=>{if("|"==e[s])if(r=!r,r)n={colStart:o};else{n.colEnd=o,n.rowStart=t,n.rowEnd=t+1,n.element=e.substring(f[n.colStart]+1,f[n.colEnd]-1).trim();let s=findObject(p,n.colStart,n.colEnd,t,n.element);s?s.rowEnd=t+1:p.push(n),o<f.length&&(r=!0,n={colStart:o})}}))}));let w=t.match(/LAYOUT\s*\r?\n=+\r?\n.+?\r?\n=+\r?\n(Row\s+Heights.+?Col\s+Widths.+?)\r?\n=+[\r?\n]*/ms),S=w&&w.length>1?w[1]:"",$=S.match(/^\s*Row\s+Heights\s+\=\s+(.+?)$/ms),C=[];$&&$.length>1&&(C=$[1].split(",")),C.forEach(((e,t)=>C[t]=e.trim()));let E=S.match(/^\s*Col\s+Widths\s+\=\s+(.+?)$/ms),_=[];E&&E.length>1&&(_=E[1].split(",")),_.forEach(((e,t)=>_[t]=e.trim()));let b={rows:g.length,columns:f.length-1,rowHeights:C,colWidths:_,elementsAndPlacements:p};e.componentHTML=await generateFormHTML(e,r,l,a,e.getAttribute("css"),b)}async function generateFormHTML(e,t,n,r,s,o){e.webscrolls_env||(e.webscrolls_env={}),e.webscrolls_env.formGeneratorIDs||(e.webscrolls_env.formGeneratorIDs=[]),o.rowHeights.length<o.rows.length&&o.rowHeights.push(Array(o.rows.length-o.rowHeights.length).fill("auto")),o.colWidths.length<o.columns.length&&o.colWidths.push(Array(o.columns.length-o.colWidths.length).fill("auto"));let l=`${s?`<link rel="stylesheet" type="text/css" href="${s}">`:""}\n\t<style>\n\t.grid-container {\n\t\tdisplay: grid;\n\t\tgrid-template-rows: ${o.rowHeights.join(" ")};\n\t\tgrid-template-columns: ${o.colWidths.join(" ")};\n\t}\n\t`,i=`<div class="grid-container${n.containerClasses?" "+n.containerClasses:""}">\n\t`;for(const[r,s]of o.elementsAndPlacements.entries()){l+=`.item${r} {\n\t\t\tgrid-column: ${s.colStart+1} / ${s.colEnd+1};\n\t\t\tgrid-row: ${s.rowStart+1} / ${s.rowEnd+1};\n\t\t\toverflow: hidden;\t\t\n\t\t}\n\t\t`;let o=JSON.parse(t)[s.element],m=o.html||"input";o.name=t.name||s.element,i+=`<div class="item${r}${n.itemClasses?" "+n.itemClasses:""}${n.perItemClass?` ${n.perItemClass}-${o.name}`:""}"><${m}`,delete o.html;let a=o.__org_monkshu_innerHTML||"";delete o.__org_monkshu_innerHTML;for(const t of Object.keys(o)){let n=await evalAttrValue(o[t]);i+=` ${t}="${n}"`,"id"==t.toLowerCase()&&e.webscrolls_env.formGeneratorIDs.push(n)}i+=`>${a}</${m}></div>`}return l+=r,l+="</style>",i+="</div>",l+i}async function evalAttrValue(e){let t=(window[e]||e).toString();return await router.expandPageData(t,session.get($$.MONKSHU_CONSTANTS.PAGE_URL),{})}function findObject(e,t,n,r,s){for(let o of e)if(o.colStart==t&&o.colEnd==n&&o.rowEnd==r&&o.element==s)return o;return null}const trueWebComponentMode=!0;export const form_generator={trueWebComponentMode:true,register:register,elementConnected:elementConnected,submit:submit};